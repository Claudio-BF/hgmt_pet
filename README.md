# TOF-PET with Laminar MCPs


## Overview


This project presents simulations of a time-of-flight positron emission tomography (TOF-PET) scanner using **laminar microchannel plates (LMCPs)**. The approach leverages **surface direct conversion** of gamma rays to electrons, eliminating the need for traditional scintillator and photodetector subsystems. However, the simulation can be easily adapted for any PET scanner which relies on very high timing resolution.


## Notable Features


- **Covariance Matrices:**
Rather than standard LORs, covariance matrices are used to keep track of uncertainties. This due to the assumption that the timing resolution is on the order of the spatial resolution.


- **Truth Information:**
Keeps track of truth information, provides detailed statistics, and provides visualization. Check out `plots/detector_diagnostics.txt` in this repo to see a standard output.


- **Algorithms:**
Principal component analysis is used to split the hits from an annihilation into two Compton chains. A deep sets neural network is used to select the first scatter from each Compton chain to generate a measurement, achieving greater accuracy than naive algorithms. Finally, an expectation maximization algorithm is used to generate the image.


## Detector Design


- **Structure:**
  - 12 cylindrical Kapton LMCP layers, each 2.54 cm thick
  - Layers separated by 2.46 cm of air
  - Inner radius: 45 cm
  - Outer radius: 105 cm
  - Length: 200 cm (z-axis)


- **Visualization:**
  - Run `hgmt_lor_creator` with the `-v20` flag to generate visualization data. Then run `scripts/visualize.py`
  - Event visualizations:
      - Red: Source annihilation
      - Green: Detection
      - Grey: No detection






## Installation and Setup Guide


Follow these steps to install and set up the TOF-PET simulation using Kapton Laminar MCPs. A Linux operating system is required.


### 2. Install Required Software


- TOPAS (Geant4-based Toolkit):
  - Download and install from https://www.topasmc.org/


- Python Packages:
  - Required packages: pytorch, numpy, matplotlib, vispy (if you want the visualization)








### 3. Configure Simulation Extensions


- Copy the AnnihilScorer extensions from hgmt_pet/extensions to your TOPAS extensions folder.
- Recompile TOPAS to include the new extensions.
- Refer to the TOPAS installation guide for detailed instructions.


### 4. Run the Simulation


- Create a folder called `data` in the home directory of the repository. Execute `bash scan.sh` to generate and run the simulation:


- This script will:
   - Generate the simulation file (hgmt_detector_derenzo.topas).
   - Run the simulation using TOPAS.
   - Output a binary file (HGMTDerenzo) in the data folder.


### 5. Neural Network and Rendering Setup








- Set the PYTORCH_PATH environment variable to the correct path in your shell configuration (e.g., .bashrc). For me this is `/usr/lib/python3.13/site-packages/torch`.
- Run `make` in `neural_network`, `rendering`, `scripts`, and `/`.



### 6. Model Training and Diagnostics


- Train the neural network and run diagnostics:


```
bash neural_network/make_model.sh
bash scripts/diagnostics.sh
```








- Check the generated graphs to ensure the simulation is functioning correctly.


### 7. Analyze and Visualize Results


- Generate the LORs and view images:


```
bash analyze.sh
bash rendering/view.sh
```


## Changing the Simulation


- **Simulation:**
- See `src/hgmt_structs.h` to change simulation parameters. The number of threads is set in `src/hgmt_lor_creator.c`. The detection efficiency is paramaterized by the energy of the electron and follows the curve given by `simulation_materials/kapton_effs.csv`. Check out `is_detected` in `src/hgmt_structs.c`. These CSV files may be generated by the LMCP simulations in the references.
- **Rendering:**
   - See `rendering/imager.h` to change imaging parameters. The number of threads is set in `rendering/imager.c`.
- **Neural Network:**
   - See `neural_network/trainer.py` Changing the architecture in a fundamental way may require you to modify `neural_network/model_wrapper.cc` and `src/compton_chain_ordering.c` as well.
- **Detector:**
   - If you want to change the detector geometry, the physics of the simulation, or the number of threads for topas, check out `simulation_materials/make_hgmt_detector_derenzo.py` and `simulation_materials/derenzo_300keV_100.topas`. Note that you need to specify the thickness and inner radii of the detector in `src/hgmt_structs.h`.


## References


- [TOPAS Geant4 Toolkit](https://www.topasmc.org/)
- [LMCP Simulations](https://github.com/cameronpoe/LMCP/tree/claudiobf/newsims)
- [Old Repository](https://github.com/cameronpoe/hgmt_lor_creator/tree/hgmt_pet_upgrade)
- [Other Related Stuff](https://github.com/cameronpoe/topas_truth_d)
